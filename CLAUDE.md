# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

The **spec-driven** plugin enables specification-driven development using formal verification tools (Dafny + TLA+) to generate correct software from user intent. It extracts formal assertions from natural language requirements, verifies them using formal methods, generates provably correct implementations, and scaffolds runnable projects.

## Dual Formal Model Architecture

The plugin uses two co-evolving formal models:

| Model | Focus | Tool | Purpose |
|-------|-------|------|---------|
| **Structure (Dafny)** | Single moment in time | Dafny verifier (Z3-backed) | Entity types, data constraints, method contracts |
| **Behavior (TLA+)** | Sequences of states | TLC model checker | State machines, temporal properties, concurrency |

**Key distinction**: Dafny models **space** (single state), TLA+ models **time** (state sequences).

## Assertion Classification Decision Tree

**Single moment in time?**
- YES → Dafny (Structure): data constraints, entity invariants, pre/postconditions
- NO → TLA+ (Behavior): liveness, safety, ordering, fairness properties

## Plugin Components

### Commands (`/commands`)

**Specification Phase:**
- `/probe-domain` - Bootstrap specification by identifying software archetype and domain
- `/interview` - Extract formal assertions from natural language requirements
- `/verify` - Run formal verification on specs (dafny verify, tlc)
- `/generate` - Generate implementation code from verified specifications
- `/reverse-engineer` - Extract specifications from existing codebase
- `/show-spec` - Display current specification state and assertion coverage
- `/resolve-conflict` - Resolve contradictions found during verification

**Execution Phase (Closing the Loop):**
- `/scaffold` - Generate project infrastructure (package.json, tsconfig, entry points)
- `/test` - Run tests and generate assertion coverage report
- `/dev` - Start local development with spec-aware hot reloading
- `/deploy` - Generate Docker deployment artifacts

### Agents (`/agents`)

**Specification Agents:**
- `assertion-generator` - Suggests candidate assertions from conversation
- `spec-validator` - Validates specs after changes
- `code-generator` - Generates TypeScript code from verified specs
- `conflict-resolver` - Explains and resolves verification failures

**Execution Agents:**
- `project-scaffolder` - Proactively scaffolds runnable projects after generation
- `runtime-validator` - Diagnoses runtime failures and maps to source assertions

### Skills (`/skills`)

**Specification Skills:**
- `assertion-taxonomy` - Classification of assertions (Structure vs Behavior)
- `dafny-patterns` - Writing Dafny specifications
- `tla-patterns` - Writing TLA+ specifications
- `archetype-templates` - Default assertions by software type
- `domain-templates` - Domain-specific assertions
- `code-generation` - Code generation from specs

**Execution Skills:**
- `runtime-patterns` - TypeScript runtime validation (Effect Schema, branded types, Effect)
- `deployment-patterns` - Docker deployment patterns for Bun applications

## Core Workflows

**Forward (Intent → Running Software):**
```
/probe-domain → /interview → /verify → /generate → /scaffold → /test → /dev → /deploy
                                                    ↑
                                           Closing the Loop
```

**Reverse (Software → Intent):**
```
/reverse-engineer → /verify → /show-spec
```

## Project Structure (When Installed)

```
your-project/
├── specs/
│   ├── dafny/structure.dfy     # Structural specifications
│   ├── tla/behavior.tla        # Behavioral specifications
│   ├── tla/behavior.cfg        # TLC configuration
│   └── assertions.json         # Assertion manifest (single source of truth)
├── src/                        # Generated/implemented code
│   ├── types/                  # Effect Schemas from Dafny types
│   ├── validation/             # Input validators from preconditions
│   ├── domain/                 # Business logic from specs
│   ├── state/                  # State machines from TLA+
│   └── index.ts                # Entry point (scaffolded)
├── tests/                      # Generated tests
├── generated/                  # Dafny extraction output
├── package.json                # Generated by /scaffold
├── tsconfig.json               # Generated by /scaffold
├── Dockerfile                  # Generated by /deploy
└── docker-compose.yml          # Generated by /deploy
```

## External Tool Requirements

- **Bun**: Runtime for generated TypeScript (v1.0+)
- **Dafny**: `dafny verify` and `dafny build` commands
- **TLA+**: `tlc` (TLC model checker)
- **Docker**: For deployment artifacts (optional)
- **Nix** (optional): `nix develop` for reproducible environment

## Code Generation Modes

1. **Verified Extraction** - Dafny compiles to JavaScript, TypeScript wraps with type declarations
2. **Spec-Guided Generation** - LLM generates TypeScript constrained by specs with Effect Schema
3. **Contract-First** - Generate interfaces with TODO implementations

## Traceability Pattern

Every generated artifact must include source links:
```typescript
/**
 * @generated
 * @source-assertion A-047: "Account balance never negative"
 * @source-spec specs/dafny/structure.dfy:45-48
 * @verified 2024-01-15T10:30:00Z
 */
```

## Key Principles

1. **Always check `specs/assertions.json`** - Single source of truth for specification state
2. **Understand the dual-model approach** - Dafny handles structure, TLA+ handles behavior; they must stay in sync
3. **Use the taxonomy** - Classification determines whether to generate Dafny or TLA+
4. **Preserve traceability** - Every generated artifact should link back to source assertions
5. **Run verification loops** - Formal tools (Dafny, TLC) are ground truth; LLM reasoning must be verified
6. **Respect the workflow** - Don't skip steps; the full workflow ensures correctness
7. **Close the loop** - Always scaffold and test; verified specs mean nothing if code doesn't run

## Workflow State Machine

```
                    ┌─────────────────────────────────────────────────┐
                    │                  SPECIFICATION                   │
                    ├─────────────────────────────────────────────────┤
 START ──→ /probe-domain ──→ /interview ──→ /verify ──┬──→ /generate ─┤
                    │              ↑          │       │               │
                    │              └──────────┘       │               │
                    │           (fix conflicts)       │               │
                    └─────────────────────────────────┼───────────────┘
                                                      │
                    ┌─────────────────────────────────┼───────────────┐
                    │                   EXECUTION     ↓               │
                    ├─────────────────────────────────────────────────┤
                    │  /scaffold ──→ /test ──→ /dev ──→ /deploy ──→ END
                    │       ↑           │                             │
                    │       └───────────┘                             │
                    │    (fix failures)                               │
                    └─────────────────────────────────────────────────┘
```

## Hooks Behavior

The plugin includes hooks that guide the workflow:

- **SessionStart**: Loads spec context and reports current state
- **PostToolUse (Write)**: Reminds to verify after spec changes; suggests scaffolding after generation
- **PreToolUse (Write)**: Warns if generating code without verified specs
- **PreToolUse (Bash)**: Warns if running tests without scaffolding
- **Stop**: Checks for incomplete workflow steps before ending session

## External References

- **Dafny Reference**: https://dafny.org/latest/DafnyRef/DafnyRef
- **TLA+ Repository**: https://github.com/tlaplus/tlaplus
- **TLA+ Examples**: https://github.com/tlaplus/Examples
- **Learn TLA+**: https://learntla.com/
- **Bun Documentation**: https://bun.sh/docs
- **Effect Documentation**: https://effect.website/docs
- **Effect Schema**: https://effect.website/docs/schema/introduction
- **Effect GitHub**: https://github.com/Effect-TS/effect
- **Effect Examples**: https://github.com/Effect-TS/examples
- **Effect LSP/DevTools**: https://effect.website/docs/getting-started/devtools/
