# spec-driven

A Claude Code plugin for specification-driven development using formal verification.

## Overview

This plugin enables Claude Code to act as a **specification-driven development agent** that:

1. **Extracts formal assertions** from natural language requirements
2. **Builds dual formal models**: Dafny (structure) + TLA+ (behavior)
3. **Verifies specifications** using `dafny verify` and TLC model checker
4. **Generates correct software** from verified specifications
5. **Reverse-engineers intent** from existing codebases

## Installation

### Prerequisites

The plugin requires Dafny and TLA+ tools. The easiest way to get them is with Nix:

```bash
# Copy the flake.nix template to your project
cp /path/to/plugin/templates/flake.nix ./flake.nix

# Enter the development shell
nix develop
```

Or install manually:
- **Dafny**: https://github.com/dafny-lang/dafny/releases (see [Dafny Reference Manual](https://dafny.org/latest/DafnyRef/DafnyRef))
- **TLA+ Tools**: https://github.com/tlaplus/tlaplus/releases (see [TLA+ Resources](#tla-resources) below)

### Plugin Installation

```bash
# Install from plugin directory
claude --plugin-dir /path/to/spec-driven
```

## Commands

### Specification Phase

| Command | Description |
|---------|-------------|
| `/probe-domain` | Bootstrap specification by identifying software archetype and domain |
| `/interview` | Extract formal assertions from natural language requirements |
| `/verify` | Run formal verification on Dafny and TLA+ specs |
| `/generate` | Generate implementation code from verified specifications |
| `/reverse-engineer` | Extract specifications from existing codebase |
| `/show-spec` | Display current specification state and assertion coverage |
| `/resolve-conflict` | Resolve contradictions found during verification |

### Execution Phase (Closing the Loop)

| Command | Description |
|---------|-------------|
| `/scaffold` | Generate project infrastructure (package.json, tsconfig, entry points) |
| `/test` | Run tests and generate assertion coverage report |
| `/dev` | Start local development with spec-aware hot reloading |
| `/deploy` | Generate Docker deployment artifacts |

## Workflow

### Forward: Intent → Running Software

```
Specification Phase:
1. /probe-domain     - Identify what you're building
2. /interview        - Extract assertions from requirements
3. /verify           - Check specifications for consistency
4. /generate         - Create implementation code

Execution Phase (Closing the Loop):
5. /scaffold         - Generate project infrastructure
6. /test             - Run tests with assertion coverage
7. /dev              - Start local development
8. /deploy           - Generate deployment artifacts
```

### Reverse: Software → Intent

```
1. /reverse-engineer - Extract specs from existing code
2. /verify           - Check extracted specs
3. /show-spec        - Review and confirm
```

## Project Structure

When using this plugin, your project will have:

```
your-project/
├── specs/
│   ├── dafny/
│   │   └── structure.dfy    # Structural specs (types, contracts)
│   ├── tla/
│   │   ├── behavior.tla     # Behavioral specs (state machines)
│   │   └── behavior.cfg     # TLC configuration
│   └── assertions.json      # Assertion manifest (single source of truth)
├── src/                     # Generated/implemented code
│   ├── types/               # Effect Schemas from Dafny types
│   ├── validation/          # Input validators from preconditions
│   ├── domain/              # Business logic from specs
│   ├── state/               # State machines from TLA+
│   └── index.ts             # Entry point (scaffolded)
├── tests/                   # Generated tests
├── generated/               # Dafny extraction output
├── package.json             # Generated by /scaffold
├── tsconfig.json            # Generated by /scaffold
├── Dockerfile               # Generated by /deploy
├── docker-compose.yml       # Generated by /deploy
└── flake.nix               # Nix development environment
```

## Skills

The plugin provides specialized knowledge for:

### Specification Skills

- **assertion-taxonomy**: Classification of assertions (structure vs behavior)
- **dafny-patterns**: Writing Dafny specifications
- **tla-patterns**: Writing TLA+ specifications
- **archetype-templates**: Default assertions by software type
- **domain-templates**: Domain-specific assertions (finance, auth, etc.)
- **code-generation**: Generating TypeScript from specs

### Execution Skills

- **runtime-patterns**: TypeScript runtime validation (Effect Schema, branded types)
- **deployment-patterns**: Docker deployment patterns for Bun applications

## Agents

The plugin includes proactive agents:

### Specification Agents

- **assertion-generator**: Suggests assertions from conversation
- **spec-validator**: Validates specs after changes
- **conflict-resolver**: Explains and resolves verification failures
- **code-generator**: Generates code from verified specs

### Execution Agents

- **project-scaffolder**: Proactively scaffolds runnable projects after generation
- **runtime-validator**: Diagnoses runtime failures and maps to source assertions

## Assertion Types

### Structure (Dafny)

| Type | Example |
|------|---------|
| Data constraint | "Age must be positive" |
| Invariant | "Balance never negative" |
| Precondition | "Can withdraw only if sufficient funds" |
| Postcondition | "Deposit increases balance by exact amount" |

### Behavior (TLA+)

| Type | Example |
|------|---------|
| Safety | "Never process payment twice" |
| Liveness | "Every request eventually gets response" |
| Ordering | "Auth must happen before API call" |
| Fairness | "No request starves indefinitely" |

## Example Session

```
You: I want to build a banking API where users can deposit and withdraw money

Claude: I'll use /probe-domain to set up your project...
        Detected: Web Service archetype, Finance domain
        Loaded 20 seed assertions

You: Users shouldn't be able to withdraw more than their balance

Claude: [assertion-generator agent activates]
        I've identified these assertions:
        - A-001: "Balance must be non-negative" (invariant)
        - A-002: "Withdraw requires amount <= balance" (precondition)
        - A-003: "Successful withdraw decreases balance by exact amount" (postcondition)

You: Confirm all

Claude: Added to specs/assertions.json. Running /verify...
        ✓ Dafny verification passed
        ✓ Specifications are consistent

You: Generate the code

Claude: [code-generator agent activates]
        Generated:
        - src/types/account.ts (Effect Schemas)
        - src/validation/account.ts (validators)
        - src/domain/account.ts (business logic)
        - tests/account.test.ts (property tests)

        [project-scaffolder agent activates]
        Would you like me to scaffold the project infrastructure?

You: Yes

Claude: Running /scaffold...
        Generated:
        - package.json (with Effect, Bun dependencies)
        - tsconfig.json (strict mode)
        - src/index.ts (entry point)

        Running /test...
        ✓ 12 tests passed
        ✓ 100% assertion coverage (3/3 assertions tested)

You: Deploy it

Claude: Running /deploy...
        Generated:
        - Dockerfile (multi-stage Bun build)
        - docker-compose.yml (with health checks)

        Build and run with: docker compose up --build
```

## Configuration

Create `.claude/spec-driven.local.md` for project-specific settings:

```yaml
---
archetype: web-service
domains:
  - finance
  - auth
preferences:
  autoVerify: true
  generateTests: true
  targetLanguage: typescript
---

# Project-specific notes and context
```

## TLA+ Resources

Essential resources for writing and understanding TLA+ specifications:

| Resource | Description |
|----------|-------------|
| [TLA+ Repository](https://github.com/tlaplus/tlaplus) | Official TLA+ tools (TLC model checker, SANY parser, PlusCal translator) |
| [TLA+ Examples](https://github.com/tlaplus/Examples) | Curated collection of TLA+ specifications including Paxos, Two-Phase Commit, and more |
| [TLA+ Cheatsheet](https://lamport.azurewebsites.net/tla/summary-standalone.pdf) | Quick reference for TLA+ operators and syntax |
| [Learn TLA+](https://learntla.com/) | Interactive tutorial for learning TLA+ |
| [TLA+ Home](https://lamport.azurewebsites.net/tla/tla.html) | Official TLA+ website with video course and documentation |

## Dafny Resources

Essential resources for writing and understanding Dafny specifications:

| Resource | Description |
|----------|-------------|
| [Dafny Repository](https://github.com/dafny-lang/dafny) | Official Dafny verification language |
| [Dafny Reference Manual](https://dafny.org/latest/DafnyRef/DafnyRef) | Complete language reference |
| [Dafny Tutorial](https://dafny.org/latest/OnlineTutorial/guide) | Getting started guide |

## Effect Resources

This plugin uses [Effect](https://effect.website/) for TypeScript runtime validation and error handling:

| Resource | Description |
|----------|-------------|
| [Effect Documentation](https://effect.website/docs) | Official Effect documentation |
| [Effect Schema](https://effect.website/docs/schema/introduction) | Schema validation (replaces Zod) |
| [Effect GitHub](https://github.com/Effect-TS/effect) | Effect source code repository |
| [Effect Examples](https://github.com/Effect-TS/examples) | Example projects using Effect |
| [Effect LSP/DevTools](https://effect.website/docs/getting-started/devtools/) | IDE integration and developer tools |

## Bun Resources

This plugin targets [Bun](https://bun.sh/) as the runtime for generated TypeScript:

| Resource | Description |
|----------|-------------|
| [Bun Documentation](https://bun.sh/docs) | Official Bun documentation |
| [Bun Runtime](https://bun.sh/docs/runtime) | JavaScript runtime features |
| [Bun Package Manager](https://bun.sh/docs/cli/install) | Fast package management |
| [Bun Test Runner](https://bun.sh/docs/cli/test) | Built-in test runner |

## Docker Resources

This plugin generates Docker deployment artifacts for containerizing Bun applications:

| Resource | Description |
|----------|-------------|
| [Dockerfile Reference](https://docs.docker.com/reference/dockerfile/) | Complete Dockerfile instruction reference |
| [Dockerfile Best Practices](https://docs.docker.com/build/building/best-practices/) | Official best practices guide |
| [Multi-stage Builds](https://docs.docker.com/build/building/multi-stage/) | Building smaller, more secure images |
| [Compose File Reference](https://docs.docker.com/reference/compose-file/) | Docker Compose specification |
| [Docker Security](https://docs.docker.com/engine/security/) | Container security overview |

## Nix Resources

This plugin provides a [Nix flake](https://nix.dev/concepts/flakes) for reproducible development environments:

| Resource | Description |
|----------|-------------|
| [Nix Manual](https://nix.dev/manual/nix/2.28/) | Official Nix reference manual |
| [Nix Best Practices](https://nix.dev/guides/best-practices) | Guidelines for writing quality Nix code |
| [Nix Flakes](https://nix.dev/concepts/flakes) | Introduction to Nix flakes |
| [nix.dev Tutorials](https://nix.dev/tutorials/) | Getting started with Nix |

## License

MIT
